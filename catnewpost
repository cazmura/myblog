#!/bin/bash

# The Cat APIã‚’ä½¿ã£ã¦çŒ«ã®OGPç”»åƒä»˜ãè¨˜äº‹ã‚’ä½œæˆã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# ä½¿ã„æ–¹: ./newpost "è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«"

title="${1:-untitled}"
date=$(date +"%Y-%m-%dT%H:%M:%S+09:00")
filename="${title}.md"
filepath="/Users/kazunari/Obshidian/00_myblog/content/blog/${filename}"

# The Cat API ã‚­ãƒ¼ï¼ˆç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã€ãªã‘ã‚Œã°DEMO-API-KEYï¼‰
cat_api_key="${CAT_API_KEY:-DEMO-API-KEY}"

# ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
timestamp=$(date +%Y%m%d%H%M%S)
image_filename="cat-${timestamp}.jpg"
image_path="/Users/kazunari/Obshidian/00_myblog/static/images/${image_filename}"

echo "ðŸ± çŒ«ç”»åƒã‚’å–å¾—ä¸­..."

# The Cat APIã‹ã‚‰çŒ«ç”»åƒURLã‚’å–å¾—
cat_image_url=$(curl -s -H "x-api-key: ${cat_api_key}" \
    "https://api.thecatapi.com/v1/images/search?size=med&mime_types=jpg&format=json&order=RANDOM&limit=1" \
    | grep -o '"url":"[^"]*' | sed 's/"url":"//')

if [ -z "$cat_image_url" ]; then
    echo "âŒ çŒ«ç”»åƒã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã§è¨˜äº‹ã‚’ä½œæˆã—ã¾ã™ï¼‰"
    # ç”»åƒå–å¾—å¤±æ•—æ™‚ã¯ images ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç©ºã«ã™ã‚‹
    cat > "${filepath}" <<EOF
+++
title = "${title}"
date = "${date}"
draft = false
tags = []
images = []
+++

è¨˜äº‹ã®å†…å®¹ã‚’ã“ã“ã«æ›¸ã
EOF
else
    echo "âœ… çŒ«ç”»åƒã‚’å–å¾—: ${cat_image_url}"
    echo "ðŸ’¾ ç”»åƒã‚’ä¿å­˜ä¸­..."

    # ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    curl -s -o "${image_path}" "${cat_image_url}"

    if [ -f "${image_path}" ]; then
        echo "âœ… ç”»åƒã‚’ä¿å­˜: ${image_filename}"
        # ç”»åƒãƒ‘ã‚¹ä»˜ãã§è¨˜äº‹ã‚’ä½œæˆ
        cat > "${filepath}" <<EOF
+++
title = "${title}"
date = "${date}"
draft = false
tags = []
images = ["/images/${image_filename}"]
+++

è¨˜äº‹ã®å†…å®¹ã‚’ã“ã“ã«æ›¸ã
EOF
    else
        echo "âŒ ç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç”»åƒãªã—ã§è¨˜äº‹ã‚’ä½œæˆã—ã¾ã™ï¼‰"
        cat > "${filepath}" <<EOF
+++
title = "${title}"
date = "${date}"
draft = false
tags = []
images = []
+++

è¨˜äº‹ã®å†…å®¹ã‚’ã“ã“ã«æ›¸ã
EOF
    fi
fi

echo "âœ“ Created: ${filepath}"
